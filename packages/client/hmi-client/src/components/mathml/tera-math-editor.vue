<template>
	<section class="math-editor">
		<div :class="expandedDiv">
			<div v-if="isEditingEquation" class="input-label">MathLive</div>
			<div
				class="eq"
				@mouseenter="hover = true"
				@mouseleave="hover = false"
				@focus="hover = true"
				@blur="hover = false"
			>
				<math-field
					:class="mathFieldStyle"
					ref="mathLiveField"
					:disabled="!isEditingEq"
					@click="isEditingEq ? (isEditingEquation = true) : null"
					@focus="showKeyboard"
					@blur="hideKeyboard"
					@keyup="
						latexTextInput = mathLiveField?.getValue('latex-unstyled')
							? mathLiveField?.getValue('latex-unstyled')
							: ''
					"
				>
				</math-field>
				<section class="menu">
					<Button
						type="button"
						class="delete"
						label="Delete"
						@click="toggleMenu"
						aria-haspopup="true"
						aria-controls="overlay_menu"
						:style="hover && isEditingEq && !isEditingEquation ? `display: flex` : ``"
					/>
					<Menu ref="menu" id="overlay_menu" :model="menuItems" :popup="true" />
				</section>
			</div>
			<div v-if="isEditingEquation">
				<div class="input-label">LaTeX</div>
				<section class="latex-input" v-if="isEditingEquation">
					<InputText
						v-model="latexTextInput"
						class="latex-input-text"
						id="latexInput"
						type="text"
						aria-label="latexInput"
						:unstyled="true"
						@keyup="updateEquation"
						@click="isEditingEq ? (isEditingEquation = true) : null"
					/>
				</section>
				<div class="controls">
					<span class="meta-property">Name:</span>
					<span class="meta-property-value" @dblclick="nameInput = false">
						<InputText
							v-model="name"
							class="control-button"
							:disabled="nameInput"
							@blur="nameInput = true"
						/>
					</span>
					<span class="meta-property">ID:</span>
					<span class="meta-property-value" @dblclick="idInput = false">
						<InputText
							v-model="id"
							class="control-button"
							:disabled="idInput"
							@blur="idInput = true"
						/>
					</span>
					<Button
						class="control-button"
						label="Save"
						aria-label="Save"
						@click="isEditingEquation = false"
					/>
					<Button
						class="control-button"
						label="Cancel"
						aria-label="Cancel"
						@click="isEditingEquation = false"
					/>
				</div>
			</div>
		</div>
	</section>
</template>

<script setup lang="ts">
import { ref, watch, onMounted, computed } from 'vue';
import { Mathfield, MathfieldElement } from 'mathlive';
import InputText from 'primevue/inputtext';
import Button from 'primevue/button';
import Menu from 'primevue/menu';
// import { logger } from '@/utils/logger';

const mathLiveField = ref<Mathfield | null>(new MathfieldElement({ fontsDirectory: 'fonts/' }));
const emit = defineEmits(['equation-updated', 'delete']);
const hover = ref(false);
const latexTextInput = ref<string>('');
const isEditingEquation = ref(false);

const menu = ref();
const nameInput = ref(true);
const idInput = ref(true);

const props = defineProps({
	// LaTeX formula to be populated
	latexEquation: {
		type: String,
		required: true
	},
	// Show edit button
	isEditable: {
		type: Boolean,
		default: true
	},
	// Is the edit button activated?
	isEditingEq: {
		type: Boolean,
		default: false
	},
	// check if the mathml is valid
	isMathMlValid: {
		type: Boolean,
		default: true
	},
	index: {
		type: Number,
		required: true
	},
	id: {
		type: String,
		required: false,
		default: 'New Id'
	},
	name: {
		type: String,
		required: false,
		default: 'Name'
	}
});

const id = ref(props.id);
const name = ref(props.name);
const expandedDiv = computed(() => (isEditingEquation.value ? `expanded-div` : ``));

defineExpose({
	mathLiveField,
	isEditingEquation,
	id: id.value,
	name: name.value
});

const menuItems = ref([
	{
		items: [
			{
				label: 'Confirm Delete?',
				command: () => {
					emit('delete', props.index);
				}
			}
		]
	}
]);

const toggleMenu = (event) => {
	event.target.style = `display:flex`;
	menu.value.toggle(event);
};

const mathFieldStyle = computed(() => {
	if (isEditingEquation.value) {
		return `mathlive-equation editing2`;
	}

	return props.isEditingEq ? `mathlive-equation editing` : `mathlive-equation`;
});

const updateEquation = () => {
	emit(
		'equation-updated',
		props.index,
		latexTextInput.value,
		mathLiveField.value?.getValue('math-ml'),
		name.value,
		id.value
	);
};

const renderEquations = () => {
	mathLiveField.value?.setValue(props.latexEquation, { suppressChangeNotifications: true });
};

const showKeyboard = () => {
	mathLiveField.value?.setOptions({ virtualKeyboardMode: 'manual' });
};

const hideKeyboard = () => {
	mathLiveField.value?.setOptions({ virtualKeyboardMode: 'off' });
};

watch(
	() => props.latexEquation,
	() => {
		if (props.latexEquation === '') {
			isEditingEquation.value = true;
		}
		renderEquations();
	}
);

onMounted(() => {
	if (props.latexEquation === '') {
		isEditingEquation.value = true;
	}
	latexTextInput.value = props.latexEquation;
	renderEquations();
});
</script>

<style scoped>
.eq {
	position: relative;
	display: flex;
	flex-grow: 1;
}

math-field {
	border-radius: 4px;
	border: none;
	outline: none;
	font-size: 1em;
	width: 99%;
	flex-grow: 1;
	transition: background-color 0.3s ease-in-out, color 0.3s ease-in-out, opacity 0.3s ease-in-out;
}

math-field[disabled] {
	opacity: 1;
}

.mathlive-equation {
	flex-direction: row;
	padding: 10px;
	align-items: center;
	width: 99%;
	margin: 5px;
	padding-left: 20px;
	flex-grow: 1;
}

.math-editor {
	display: flex;
	flex-direction: column;
	resize: horizontal;
	justify-content: center;
}

.input-label {
	padding-left: 10px;
	padding-bottom: 5px;
	padding-top: 5px;
	font-family: var(--font-family);
}

.expanded-div {
	background-color: var(--gray-0);
	padding: 10px;
	margin: 10px;
	box-shadow: 0 3px 10px rgb(0 0 0 / 0.2);
	border: 1px solid var(--surface-border);
	border-radius: 3px;
}

.editing {
	background-color: var(--gray-0);
	cursor: pointer;
}

.editing:hover {
	background-color: var(--surface-highlight);
	cursor: pointer;
}

.editing2 {
	border: 1px solid var(--surface-border);
	background-color: var(--gray-0);
	margin-right: 10px;
}

.editing2:hover {
	background-color: var(--gray-0);
}

.editeq {
	border: 1px solid var(--gray-300);
}

.latex-input-text {
	flex-direction: row;
	background-color: var(--gray-0);
	border-color: var(--gray-300);
	padding: 10px;
	height: auto;
	resize: none;
	overflow-y: hidden;
	display: flex;
	align-items: center;
	justify-content: center;
	max-width: 100%;
	width: 99%;
	margin: 5px;
}

.latex-input-text:focus {
	box-shadow: none !important;
	outline: none;
}

.menu {
	position: absolute;
	right: 20px;
	padding-right: 10px;
	top: 50%;
	transform: translateY(-50%);
	margin: auto 0;
}

.delete {
	background-color: white;
	height: 30px;
	color: black;
	background-color: var(--gray-0);
	justify-content: flex-end;
	width: 70px;
	border: 1px solid var(--surface-border);
	display: none;
}

.controls {
	display: flex;
	flex-direction: row;
	justify-content: flex-end;
	padding-right: 15px;
}

.control-button {
	background-color: white;
	height: 30px;
	color: var(--gray-1000);
	background-color: var(--gray-0);
	justify-content: flex-end;
	width: 70px;
	margin-left: 10px;
	border: 1px solid var(--surface-border);
	border-radius: 6px;
	font-family: Figtree;
	font-size: 10px;
	font-weight: 500;
	line-height: 16px;
	letter-spacing: 0.75px;
}

.control-button:disabled {
	color: var(--gray-1000);
	opacity: 100%;
	border: none;
}

.meta-data {
	padding-left: 10px;
	padding-bottom: 5px;
}

.meta-property {
	font-weight: bold;
	padding-right: 15px;
}

.meta-property-value {
	padding-right: 15px;
}
</style>
