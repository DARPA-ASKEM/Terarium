<template>
	<header
		v-if="showHeader"
		id="asset-top"
		:class="{
			'overview-banner': pageType === ProjectPages.OVERVIEW,
			'with-tabs': tabs.length > 1
		}"
	>
		<!-- put the buttons above the title if there is an overline -->
		<div v-if="overline" class="row">
			<span class="overline">{{ overline }}</span>
			<slot name="edit-buttons" />
			<Button
				v-if="featureConfig.isPreview"
				class="close"
				icon="pi pi-times"
				rounded
				text
				@click="emit('close-preview')"
			/>
		</div>
		<!--For naming asset such as model or code file-->
		<div class="row">
			<slot name="name-input" />
			<h4 v-if="!isNamingAsset" :class="{ shrink: shrinkHeader }">
				{{ name }}
			</h4>
			<slot v-if="!overline" name="edit-buttons" />
			<Button
				v-if="!overline && featureConfig.isPreview"
				class="close"
				icon="pi pi-times"
				rounded
				text
				@click="emit('close-preview')"
			/>
		</div>
		<!--put model contributors here too-->
		<span v-if="authors" class="authors">
			<i :class="authors.includes(',') ? 'pi pi-users' : 'pi pi-user'" />
			<span v-html="authors" />
		</span>
		<div v-if="doi">
			DOI:
			<a :href="`https://doi.org/${doi}`" rel="noreferrer noopener" v-html="doi" />
		</div>
		<div v-if="publisher" v-html="publisher" />
		<!--created on: date-->
		<div class="header-buttons">
			<slot name="bottom-header-buttons" />
		</div>
		<slot name="summary" />
		<TabView
			v-if="tabs.length > 1"
			:active-index="selectedTabIndex"
			@tab-change="(e) => emit('tab-change', e)"
		>
			<TabPanel v-for="(tab, index) in tabs" :key="index" :header="tab.props?.tabName" />
		</TabView>
	</header>
	<main v-if="!isLoading" ref="assetElementRef" @scroll="updateScrollPosition">
		<section :class="overflowHiddenClass">
			<template v-for="(tab, index) in tabs" :key="index">
				<component :is="tab" v-show="selectedTabIndex === index" />
			</template>
			<slot name="default" />
			<tera-asset-nav
				v-if="showTableOfContents && assetElementRef"
				:element-with-nav-ids="assetElementRef"
			/>
		</section>
	</main>
	<tera-progress-spinner v-else :font-size="2" is-centered />
</template>

<script setup lang="ts">
import { ref, computed, watch, PropType, useSlots } from 'vue';
import { useRoute } from 'vue-router';
import Button from 'primevue/button';
import { FeatureConfig } from '@/types/common';
import { ProjectPages } from '@/types/Project';
import { AssetType } from '@/types/Types';
import TabView from 'primevue/tabview';
import TabPanel from 'primevue/tabpanel';
import TeraProgressSpinner from '../widgets/tera-progress-spinner.vue';
import TeraAssetNav from '../widgets/tera-asset-nav.vue';

const props = defineProps({
	name: {
		type: String,
		default: ''
	},
	overline: {
		type: String,
		default: null
	},
	authors: {
		type: String,
		default: null
	},
	doi: {
		type: String,
		default: null
	},
	publisher: {
		type: String,
		default: null
	},
	featureConfig: {
		type: Object as PropType<FeatureConfig>,
		default: { isPreview: false } as FeatureConfig
	},
	showHeader: {
		type: Boolean,
		default: true
	},
	// Booleans default to false if not specified
	showTableOfContents: Boolean,
	isNamingAsset: Boolean,
	hideIntro: Boolean,
	isLoading: Boolean,
	overflowHidden: Boolean,
	selectedTabIndex: {
		type: Number,
		default: 0
	}
});

const emit = defineEmits(['close-preview', 'tab-change']);

const slots = useSlots();
const assetElementRef = ref();
const scrollPosition = ref(0);

const shrinkHeader = computed(() => scrollPosition.value > 20); // Shrink header once we scroll down a bit

const pageType = useRoute().params.pageType as ProjectPages | AssetType;

const overflowHiddenClass = computed(() => (props.overflowHidden ? 'overflow-hidden' : ''));

function updateScrollPosition(event) {
	scrollPosition.value = event?.currentTarget.scrollTop;
}

const tabs = computed(() => {
	if (slots.tabs?.()) {
		if (slots.tabs().length === 1) {
			// if there is only 1 component we don't need to know the tab name and we can render it.
			return slots.tabs();
		}

		return slots.tabs().filter((vnode) => vnode.props?.tabName);
	}
	return [];
});

// Reset the scroll position to the top on asset change
watch(
	() => props.name,
	() => {
		document.getElementById('asset-top')?.scrollIntoView();
	}
);
</script>

<style scoped>
main {
	display: flex;
	flex-direction: column;
	flex: 1;
	background-color: var(--surface-section);
	overflow-y: auto;
	overflow-x: hidden;
}

main > section {
	display: flex;
	flex: 1;
	& > :deep(*:not(nav, i)) {
		flex: 1;
	}
}

header {
	display: flex;
	flex-direction: column;
	justify-content: space-between;
	height: fit-content;
	padding: var(--gap-small) var(--gap);
	gap: var(--gap-small);
	background-color: var(--surface-ground-transparent);
	backdrop-filter: blur(6px);
	border-bottom: 1px solid var(--surface-border-light);
	overflow: hidden;
}

header h4 {
	align-self: center;
	overflow: hidden;
	text-align: left;
}

header h4.shrink {
	white-space: nowrap;
	overflow: hidden;
	text-overflow: ellipsis;
	flex-grow: 1;
	flex-shrink: 1;
	max-width: fit-content;
}

header > button {
	align-self: flex-start;
}

header.overview-banner section {
	width: 100%;
	max-width: 100%;
}

header.with-tabs {
	padding: var(--gap-small) var(--gap) 0;
}

.overview-banner {
	background:
		url('@/assets/svg/terarium-icon-transparent.svg') no-repeat right 20% center,
		linear-gradient(45deg, #8bd4af1a, #d5e8e5 100%) no-repeat;
	background-size: 25%, 100%;
}

.row {
	display: flex;
	flex-direction: row;
	align-items: center;
	gap: var(--gap);
}

.close {
	margin-left: auto;
}

main:deep(.p-inputtext.p-inputtext-sm) {
	padding: 0.65rem 0.65rem 0.65rem 3rem;
}

/* Input asset name */
header section:deep(> input) {
	width: var(--constrain-width);
	font-size: var(--font-body-medium);
}

.authors i {
	margin-right: var(--gap-small);
}

.authors ~ * {
	color: var(--text-color-subdued);
}

.header-buttons:empty {
	display: none;
}

.header-buttons,
header aside {
	display: flex;
	flex-direction: row;
	gap: var(--gap-small);
}

/* Affects child components put in the slot*/
main:deep(.p-accordion) {
	margin: var(--gap-small);
}

main:deep(.p-accordion-content) {
	padding-bottom: var(--gap-small);
}

main:deep(.p-accordion-content ul) {
	display: flex;
	flex-direction: column;
	gap: var(--gap-small);
	list-style: none;
}

main:deep(.p-accordion-content > textarea) {
	border: 1px solid var(--surface-border-light);
	border-radius: var(--border-radius);
	padding: 5px;
	resize: none;
	overflow-y: hidden;
	width: 100%;
}

main:deep(.artifact-amount) {
	font-size: var(--font-caption);
	color: var(--text-color-subdued);
	margin-left: var(--gap-1);
}

main:deep(.p-button.p-button-outlined) {
	color: var(--text-color-primary);
	box-shadow: var(--text-color-disabled) inset 0 0 0 1px;
}

.overflow-hidden {
	overflow: hidden;
}

:deep(.p-tabview .p-tabview-panels) {
	padding: 0;
}

:deep(.p-tabview-header:not(.p-highlight) .p-tabview-nav-link) {
	background: var(--tab-backgroundcolor-unselected);
}

:deep(.p-tabview .p-tabview-nav li .p-tabview-nav-link:focus) {
	background-color: var(--surface-section);
}

:deep(.p-tabview .p-tabview-nav) {
	background-color: transparent;
}
</style>
